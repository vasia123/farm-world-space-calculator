<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Калькулятор окупаемости инструментов</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    input {
      margin-bottom: 10px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      margin-top:20px;
    }
    .tool-type {
      max-width: 450px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .tool-type h2 {
      margin-top: 0;
    }
    .tool-box {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
    }
    .tool-icon {
      width: 64px;
      height: 64px;
      margin-right: 10px;
    }
    .tool-info {
      flex-grow: 1;
    }
    .tool-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .tool-resource {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .resource-icon {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
    .ton-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      background-image: url('img/ton_g.png');
      background-size: cover;
      vertical-align: middle;
      margin: 0px 5px 5px 5px;
    }
    p {
      margin: 0;
    }
    .red,
    #server-error {
      color: red;
    }
    #manual-prices,
    #fetch-prices-btn,
    #calculate-prices-btn,
    #server-prices {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Калькулятор окупаемости инструментов</h1>

  <button id="fetch-prices-btn" onclick="fetchPrices()">Обновить цены с сервера</button>
  <div id="server-error"></div>
  <div id="server-prices"></div>
  <button id="manual-prices-btn" onclick="toggleManualPrices()">Ввести цены вручную</button>

  <div id="manual-prices">
    <label for="woodPrice">Цена за единицу дерева:</label>
    <input type="number" id="woodPrice" step="0.01" value="0.0089"><br>
    <label for="foodPrice">Цена за единицу еды:</label>
    <input type="number" id="foodPrice" step="0.01" value="0.0079"><br>
    <label for="goldPrice">Цена за единицу золота:</label>
    <input type="number" id="goldPrice" step="0.01" value="0.01"><br>
  </div>
  <button id="calculate-prices-btn" onclick="calculateROI()">Рассчитать окупаемость</button>
  
  <div class="container" id="result"></div>
  
  <script>
    const precision = 3;

    function calculateROI() {
      const woodPrice = parseFloat(document.getElementById('woodPrice').value);
      const foodPrice = parseFloat(document.getElementById('foodPrice').value);
      const goldPrice = parseFloat(document.getElementById('goldPrice').value);
      
      const tools = [
        { name: 'Axe (Common)', icon: 'img/axe_common_shadow.png', profit: 5, wood: 2400, gold: 400, cooldown: 1, resource: 'Wood', energy: 10, durability: 5, maxDurability: 100 },
        { name: 'Axe (Uncommon)', icon: 'img/axe_uncommon_shadow.png', profit: 17, wood: 7200, gold: 1200, cooldown: 1, resource: 'Wood', energy: 30, durability: 15, maxDurability: 300 },
        { name: 'Axe (Rare)', icon: 'img/axe_rare_shadow.png', profit: 54, wood: 21600, gold: 3600, cooldown: 1, resource: 'Wood', energy: 60, durability: 45, maxDurability: 900 },
        { name: 'Axe (Promo)', icon: 'img/axe_promo_shadow.png', profit: 0.7, wood: 110, gold: 20, cooldown: 2, resource: 'Wood', energy: 4, durability: 1, maxDurability: 25 },
        { name: 'Bow (Common)', icon: 'img/bow_common_shadow.png', profit: 5, wood: 1200, gold: 200, cooldown: 1, resource: 'Food', energy: 0, durability: 5, maxDurability: 250 },
        { name: 'Bow (Uncommon)', icon: 'img/bow_uncommon_shadow.png', profit: 20, wood: 4800, gold: 800, cooldown: 1, resource: 'Food', energy: 0, durability: 20, maxDurability: 1000 },
        { name: 'Bow (Rare)', icon: 'img/bow_rare_shadow.png', profit: 80, wood: 19200, gold: 3200, cooldown: 1, resource: 'Food', energy: 0, durability: 32, maxDurability: 1600 },
        { name: 'Pickaxe (Common)', icon: 'img/pikaxe_common_shadow.png', profit: 50, wood: 24000, gold: 4000, cooldown: 1, resource: 'Gold', energy: 66, durability: 3, maxDurability: 250 }
      ];
      
      const toolTypes = {};
      
      for (const tool of tools) {
        if (!toolTypes[tool.resource]) {
          toolTypes[tool.resource] = [];
        }
        toolTypes[tool.resource].push(tool);
      }
      
      let resultHTML = '';
      
      for (const [resource, toolsOfType] of Object.entries(toolTypes)) {
        let toolsHTML = '';
        
        for (const tool of toolsOfType) {
          const craftCost = tool.wood * woodPrice + tool.gold * goldPrice;
          const resourcePrice = tool.resource === 'Wood' ? woodPrice : (tool.resource === 'Food' ? foodPrice : goldPrice);
          const energyCost = tool.energy / 5 * foodPrice;
          const durabilityCost = tool.durability / 5 * goldPrice;
          const grossProfitPerHour = tool.profit * resourcePrice;
          const netProfitPerHour = (grossProfitPerHour - energyCost - durabilityCost) / tool.cooldown;
          const netProfitPerDay = netProfitPerHour * 24;
          const roiHours = craftCost / netProfitPerHour;
          const roiDays = roiHours / 24;
          
          toolsHTML += `
            <div class="tool-box">
              <img class="tool-icon" src="${tool.icon}" alt="${tool.name}">
              <div class="tool-info">
                <div class="tool-name">${tool.name}</div>
                <div class="tool-resource">
                  <img class="resource-icon" src="img/${tool.resource.toLowerCase()}_shadow.png" alt="${tool.resource}">
                  Добывает: ${tool.resource}
                </div>
                <p></span>Стоимость крафта: <b>${craftCost.toFixed(precision)}</b><i class="ton-icon"></i></p>
                ${tool.energy > 0 ? `<p>Потребление энергии(5 = 1 еда): ${tool.energy} (<b>${energyCost.toFixed(precision)}</b><i class="ton-icon"></i>)</p>` : ''}
                <p>Потеря прочности(5 = 1 золото): ${tool.durability} (<b>${durabilityCost.toFixed(precision)}</b><i class="ton-icon"></i>)</p>
                <p></span>Прибыль в час: <b>${netProfitPerHour.toFixed(precision)}</b><i class="ton-icon"></i></p>
                <p></span>Прибыль в сутки: <b>${netProfitPerDay.toFixed(precision)}</b><i class="ton-icon"></i></p>
                <p>Срок окупаемости: ${roiHours > 0 ? `<b>${roiHours.toFixed(1)}</b> часов (<b>${roiDays.toFixed(1)}</b> дней)` : '<b class="red">Никогда</b>' }</p>
              </div>
            </div>
          `;
        }
        
        resultHTML += `
          <div class="tool-type">
            <h2>${resource}</h2>
            ${toolsHTML}
          </div>
        `;
      }
      
      document.getElementById('result').innerHTML = resultHTML;
    }
    
    let priceTimeout;

    function fetchPrices() {
      const fetchPricesBtn = document.getElementById('fetch-prices-btn');
      const serverPrices = document.getElementById('server-prices');
      const calculatePricesBtn = document.getElementById('calculate-prices-btn');
      const manualPrices = document.getElementById('manual-prices');
      const manualPricesBtn = document.getElementById('manual-prices-btn');
      const serverError = document.getElementById('server-error');
      
      serverError.innerHTML = '';
      manualPricesBtn.style.display = 'inline-block';
      manualPrices.style.display = 'none';
      fetchPricesBtn.style.display = 'none';
      serverPrices.style.display = 'block';
      calculatePricesBtn.style.display = 'none';

      fetch('https://app.farm-world.space/tokens.php')
        .then(response => response.json())
        .then(data => {
          document.getElementById('woodPrice').value = data.WOOD;
          document.getElementById('foodPrice').value = data.FOOD;
          document.getElementById('goldPrice').value = data.GOLD;
          calculateROI();

          const date = new Date(data.date_update * 1000);
          serverPrices.innerHTML = `<div>Загруженные цены на <b>${date.toLocaleString('ru-RU')}</b>:</div> 
          <div><img class="resource-icon" src="img/wood_shadow.png">Дерево: <b>${Number(data.WOOD).toFixed(precision)}</b><i class="ton-icon"></i></div>
          <div><img class="resource-icon" src="img/food_shadow.png">Еда: <b>${Number(data.FOOD).toFixed(precision)}</b><i class="ton-icon"></i></div>
          <div><img class="resource-icon" src="img/gold_shadow.png">Золото: <b>${Number(data.GOLD).toFixed(precision)}</b><i class="ton-icon"></i></div>`;
          priceTimeout = setTimeout(fetchPrices, 30*1000);
        })
        .catch(error => {
          const serverError = document.getElementById('server-error');
          serverError.innerHTML = `Ошибка получения цен: ${error}`;
          toggleManualPrices();
          calculateROI();
          const serverPrices = document.getElementById('server-prices');
          serverPrices.style.display = 'none';
        });
    }

    function toggleManualPrices() {
      const manualPrices = document.getElementById('manual-prices');
      const fetchPricesBtn = document.getElementById('fetch-prices-btn');
      const serverPrices = document.getElementById('server-prices');
      const calculatePricesBtn = document.getElementById('calculate-prices-btn');
      const manualPricesBtn = document.getElementById('manual-prices-btn');

      manualPrices.style.display = 'block';
      fetchPricesBtn.style.display = 'inline-block';
      serverPrices.style.display = 'none';
      calculatePricesBtn.style.display = 'inline-block';
      manualPricesBtn.style.display = 'none';

      clearTimeout(priceTimeout);
    }
    fetchPrices();

  </script>
</body>
</html>